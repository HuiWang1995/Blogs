# 后端基础实战

## 基础篇

### 创建更新订单

- 如何避免重复下单？

  让你的订单服务具备幂等性。我们可以利用数据库的这种“主键唯一约束”特性，在插入数据的时候带上主键，来解决创建订单服务的幂等性问题。

- 如何解决 ABA 问题？

  ABA 问题怎么解决？这里给你提供一个比较通用的解决方法。给你的订单主表增加一列，列名可以叫 version，也即是“版本号”的意思。每次查询订单的时候，版本号需要随着订单数据返回给页面。页面在更新数据的请求中，需要把这个版本号作为更新请求的参数，再带回给订单更新服务。

### 流量大、数据多

第一，要考虑高并发的问题。

第二，数量多，重量大。分而治之。

Cache Aside，是最简单实用的一种缓存更新策略，适用范围也最广泛。

一定要记得保留商品数据的每一个历史版本。

- 使用对象存储保存图片和视频

  可以在 Web 页面或者 App 中直接访问而不用通过后端服务来中转。页面直接通过对象存储提供的 URL 来访问，又省事儿又节约带宽。

- 将商品介绍静态化

  那不如就把这个页面事先生成好，保存成一个静态的 HTML，访问商详页的时候，直接返回这个 HTML。这就是静态化。

  商详页静态化之后，不仅仅是可以节省服务器资源，还可以利用 CDN 加速，把商详页放到离用户最近的 CDN 服务器上，让商详页访问更快。

### 对账

“对不上账”是通俗的说法，它的本质问题是，冗余数据的一致性问题。

使用数据库**事务**来保证数据一致性

- ACID 

  D（持久性），A（原子性）C（一致性）、I（隔离性）

- 隔离级别

<img src="https://static001.geekbang.org/resource/image/3c/3e/3c37eff420c7a9e41e6121ff491c8c3e.jpg" alt="img" style="zoom: 15%;" />

幻读：在实际业务中，很少能遇到幻读，即使遇到，也基本不会影响到数据准确性。

### 分布式事务

- 2PC 是一种强一致的设计，它可以保证原子性和隔离性。

  2PC 也有很明显的缺陷，整个事务的执行过程需要阻塞服务端的线程和数据库的会话。所以，只有在需要强一致、并且并发量不大的场景下，才考虑使用 2PC。

- 本地消息表非常适合解决这种分布式最终一致性的问题。

### ES搜索

- 分词

- 构建索引 倒排索引

  它的写入和更新性能都比较差

### MYSQL HA

高可用依赖的是数据复制，数据复制的本质就是从一个库备份数据，然后恢复到另外一个库中去。

全量备份 mysqldump

增量备份 binlog

## 进阶

### 访问数据库超时

慢SQL导致

批量任务导致

### 避免慢SQL

使用索引避免全表扫描

分析 SQL 执行计划

### 使用缓存保护MYSQL

Cache Aside 模式和上面的 Read/Write Through 模式非常像，它们处理读请求的逻辑是完全一样的，唯一的一个小差别就是，**Cache Aside 模式在更新数据的时候，并不去尝试更新缓存，而是去删除缓存**。

### 读写分离保护MYSQL

组件方式：也可以使用像 Sharding-JDBC 这种集成在应用中的第三方组件来实现，这些组件集成在你的应用程序内，代理应用程序的所有数据库请求，自动把请求路由到对应数据库实例上。

读写分离的方案不需要对系统做太大的改动，就可以让系统支撑的并发提升几倍到十几倍。

### MYSQL主从复制

MySQL 主库在收到客户端提交事务的请求之后，会先写入 Binlog，然后再提交事务，更新存储引擎中的数据，事务提交完成后，给客户端返回操作成功的响应。同时，从库会有一个专门的复制线程，从主库接收 Binlog，然后把 Binlog 写到一个中继日志里面，再给主库返回复制成功的响应。

异步复制是，事务线程完全不等复制响应；同步复制是，事务线程要等待所有的复制响应；半同步复制介于二者之间，事务线程不用等着所有的复制成功响应，**只要一部分复制响应回来之后，就可以给客户端返回了**。

几乎所有的存储系统和数据库，都是用这一套方法来解决备份恢复和数据复制问题的。

### 数据库越来越慢

存档历史订单数据提升查询性能

## 海量篇

### 分库分表

数据量大，就分表；并发高，就分库。

选择合适 Sharding Key 和分片算法非常重要，直接影响了分库分表的效果。一定要能兼容业务最常用的查询条件，让查询尽量落在一个分片中。



### NEW SQL

New SQL 是新一代的分布式数据库，它具备原生分布式存储系统高性能、高可靠、高可用和弹性扩容的能力，同时还兼顾了传统关系型数据库的 SQL 支持。

- CockroachDB

  CockroachDB 提供了另外两种隔离级别，分别是：Snapshot Isolation (SI) 和 Serializable Snapshot Isolation (SSI)，其中 SSI 是 CockroachDB 默认的隔离级别。

  ![img](https://static001.geekbang.org/resource/image/20/67/20e20d983ad7519e6eae11821a3f1567.jpg)

### ROCKSDB

LSM-Tree 如何兼顾读写性能？LSM-Tree 的全称是：The Log-Structured Merge-Tree，是一种非常复杂的复合数据结构，它包含了 WAL（Write Ahead Log）、跳表（SkipList）和一个分层的有序表（SSTable，Sorted String Table）。
